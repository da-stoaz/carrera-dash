<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SZ Racing</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the lights */
        @keyframes pulse-red {

            0%,
            100% {
                box-shadow: 0 0 10px #ef4444;
            }

            50% {
                box-shadow: 0 0 40px #ef4444;
            }
        }

        @keyframes pulse-green {

            0%,
            100% {
                box-shadow: 0 0 10px #22c55e;
            }

            50% {
                box-shadow: 0 0 40px #22c55e;
            }
        }

        .light {
            /* Base appearance */
            background-color: #1a1a1a;
            /* Dark, unlit bulb */
            border: 4px solid #333;
            transition: all 0.2s ease-in-out;
            border-radius: 9999px;
        }

        .light.red-on {
            background-color: #ef4444;
            /* red-500 */
            border-color: #fca5a5;
            /* red-300 */
            box-shadow: 0 0 20px #ef4444;
            animation: pulse-red 1.5s infinite;
        }

        .light.green-on {
            background-color: #22c55e;
            /* green-500 */
            border-color: #86efac;
            /* green-300 */
            box-shadow: 0 0 20px #22c55e;
            animation: pulse-green 1.5s infinite;
        }

        /* Hide scrollbar for lap history */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>
<!-- FIX: Use h-svh (small viewport height) and flex to fill the screen -->

<body class="bg-gray-900 text-gray-100 font-sans h-svh flex flex-col">

    <div class="max-w-6xl mx-auto flex flex-col gap-6 p-4 md:p-8 w-full flex-grow">

        <!-- Header -->
        <div class="flex-shrink-0 flex justify-between items-center bg-gray-800 p-4 rounded-lg shadow-lg">
            <h1 class="text-2xl md:text-4xl font-bold text-white">SZ Racing</h1>
            <div id="status-bar" class="flex items-center gap-2 text-sm">
                <div id="status-light" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span id="status-text">Connecting...</span>
            </div>
        </div>

        <!-- Main Dashboard: 16:9 Aspect Ratio Container -->
        <div
            class="aspect-[16/9] w-full bg-gray-800 rounded-lg shadow-2xl p-6 md:p-8 flex flex-col justify-between flex-grow">

            <!-- Top Section: Lights -->
            <div>
                <!-- Start Lights -->
                <div class="max-w-2xl mx-auto flex justify-center gap-4 md:gap-8">
                    <div id="light-1" class="light w-12 h-12 md:w-24 md:h-24"></div>
                    <div id="light-2" class="light w-12 h-12 md:w-24 md:h-24"></div>
                    <div id="light-3" class="light w-12 h-12 md:w-24 md:h-24"></div>
                    <div id="light-4" class="light w-12 h-12 md:w-24 md:h-24"></div>
                    <div id="light-5" class="light w-12 h-12 md:w-24 md:h-24"></div>
                </div>
                <!-- Green Light (hidden until GO) -->
                <!-- REMOVED: The separate green light div is gone. -->
            </div>

            <!-- Bottom Section: Timers & Control -->
            <div class="flex-shrink-0">
                <!-- Timers -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-8">

                    <!-- Track 1 Timer -->
                    <div class="bg-gray-900 p-6 rounded-lg shadow-inner flex flex-col">
                        <h2 class="text-xl md:text-3xl font-semibold text-blue-300 mb-4 text-center">Track 1</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Current Timers -->
                            <div>
                                <h3 class="text-lg md:text-xl text-gray-400">Last Lap</h3>
                                <div id="last-lap-1" class="text-2xl md:text-4xl font-mono font-bold text-blue-100/70">
                                    --.---<span class="text-xl">s</span>
                                </div>
                                <h3 class="text-lg md:text-xl text-gray-400 mt-2">Current Lap</h3>
                                <div id="current-lap-1" class="text-2xl md:text-4xl font-mono font-bold text-blue-100">
                                    0.000<span class="text-xl">s</span>
                                </div>
                            </div>
                            <!-- Live Lap History -->
                            <div class="border-l border-gray-700 pl-4">
                                <h3 class="text-lg md:text-xl text-gray-400">Recent Laps</h3>
                                <ol id="history-1"
                                    class="list-decimal list-inside text-lg md:text-2xl font-mono text-gray-300">
                                    <!-- JS will populate this -->
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- Track 2 Timer -->
                    <div class="bg-gray-900 p-6 rounded-lg shadow-inner flex flex-col">
                        <h2 class="text-xl md:text-3xl font-semibold text-green-300 mb-4 text-center">Track 2</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Current Timers -->
                            <div>
                                <h3 class="text-lg md:text-xl text-gray-400">Last Lap</h3>
                                <div id="last-lap-2" class="text-2xl md:text-4xl font-mono font-bold text-green-100/70">
                                    --.---<span class="text-xl">s</span>
                                </div>
                                <h3 class="text-lg md:text-xl text-gray-400 mt-2">Current Lap</h3>
                                <div id="current-lap-2" class="text-2xl md:text-4xl font-mono font-bold text-green-100">
                                    0.000<span class="text-xl">s</span>
                                </div>
                            </div>
                            <!-- Live Lap History -->
                            <div class="border-l border-gray-700 pl-4">
                                <h3 class="text-lg md:text-xl text-gray-400">Recent Laps</h3>
                                <ol id="history-2"
                                    class="list-decimal list-inside text-lg md:text-2xl font-mono text-gray-300">
                                    <!-- JS will populate this -->
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="text-center h-16"> <!-- Added fixed height to prevent layout shift -->
                    <button id="start-button"
                        class="bg-green-600 hover:bg-green-500 disabled:bg-gray-500 text-white font-bold py-4 px-10 text-2xl rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                        START RACE
                    </button>
                    <button id="stop-button"
                        class="hidden bg-red-600 hover:bg-red-500 text-white font-bold py-4 px-10 text-2xl rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                        STOP RACE
                    </button>
                    <button id="new-race-button"
                        class="hidden bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 text-2xl rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                        NEW RACE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Race Summary Modal -->
    <div id="summary-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 text-gray-100 rounded-lg shadow-2xl max-w-4xl w-full max-h-[80svh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <h2 class="text-3xl font-bold">Race Summary</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <!-- Modal Body -->
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto no-scrollbar">
                <!-- Track 1 Summary -->
                <div>
                    <h3 class="text-2xl font-semibold text-blue-300 mb-3">Track 1</h3>
                    <div id="summary-track-1-laps" class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto no-scrollbar">
                        <!-- JS will populate laps -->
                    </div>
                </div>
                <!-- Track 2 Summary -->
                <div>
                    <h3 class="text-2xl font-semibold text-green-300 mb-3">Track 2</h3>
                    <div id="summary-track-2-laps" class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto no-scrollbar">
                        <!-- JS will populate laps -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const statusLight = document.getElementById('status-light');
        const statusText = document.getElementById('status-text');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const newRaceButton = document.getElementById('new-race-button');

        const lightsRed = [
            document.getElementById('light-1'),
            document.getElementById('light-2'),
            document.getElementById('light-3'),
            document.getElementById('light-4'),
            document.getElementById('light-5'),
        ];
        // REMOVED: const lightGreen

        // Timers
        const lastLap1 = document.getElementById('last-lap-1');
        const currentLap1 = document.getElementById('current-lap-1');
        const history1 = document.getElementById('history-1');
        const lastLap2 = document.getElementById('last-lap-2');
        const currentLap2 = document.getElementById('current-lap-2');
        const history2 = document.getElementById('history-2');

        // Modal
        const summaryModal = document.getElementById('summary-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const summaryLaps1 = document.getElementById('summary-track-1-laps');
        const summaryLaps2 = document.getElementById('summary-track-2-laps');

        // --- State ---
        let ws;
        let raceStatus = "idle"; // "idle", "running", "finished"
        let jsLapStartTime_1 = 0;
        let jsLapStartTime_2 = 0;
        let animationFrameId = null;

        // --- Helper Functions ---
        function formatTime(milliseconds, showUnit = true) {
            const totalSeconds = milliseconds / 1000;
            if (showUnit) {
                return `${totalSeconds.toFixed(3)}<span class="text-xl">s</span>`;
            }
            return totalSeconds.toFixed(3);
        }

        // --- Live Timer Loop ---
        function updateTimers() {
            const now = performance.now();

            if (raceStatus === "running") {
                if (jsLapStartTime_1 > 0) {
                    currentLap1.innerHTML = formatTime(now - jsLapStartTime_1);
                }
                if (jsLapStartTime_2 > 0) {
                    currentLap2.innerHTML = formatTime(now - jsLapStartTime_2);
                }
            }

            animationFrameId = requestAnimationFrame(updateTimers);
        }

        function stopTimerLoop() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        // --- WebSocket ---
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws`;
            console.log(`Connecting to WebSocket at: ${wsUrl}`);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                statusLight.className = 'w-3 h-3 rounded-full bg-green-500';
                statusText.innerText = 'Connected';
                startButton.disabled = false;
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected. Reconnecting in 3s...');
                statusLight.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.innerText = 'Disconnected. Retrying...';
                startButton.disabled = true;
                stopTimerLoop();
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
                statusText.innerText = 'Connection Error';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                const now = performance.now();

                switch (data.type) {

                    // NEW: Add this case block
                    case 'full_state':
                        console.log("Syncing to full state:", data);
                        // Reset UI first to get a clean slate
                        resetUI();

                        // Repopulate history
                        data.track_1_laps.forEach(lapTimeSec => {
                            const li = document.createElement('li');
                            li.innerText = lapTimeSec.toFixed(3);
                            history1.prepend(li);
                        });
                        data.track_2_laps.forEach(lapTimeSec => {
                            const li = document.createElement('li');
                            li.innerText = lapTimeSec.toFixed(3);
                            history2.prepend(li);
                        });

                        // Set last lap times
                        if (data.track_1_last_lap > 0) {
                            lastLap1.innerHTML = formatTime(data.track_1_last_lap * 1000);
                        }
                        if (data.track_2_last_lap > 0) {
                            lastLap2.innerHTML = formatTime(data.track_2_last_lap * 1000);
                        }

                        // Set the correct race status
                        if (data.status === "running") {
                            raceStatus = "running";
                            // We can't know the *exact* start time, so we'll just
                            // start the timers from 0.000 for the new client.
                            // The *next* lap finish will be perfectly synced.
                            jsLapStartTime_1 = now;
                            jsLapStartTime_2 = now;
                            stopTimerLoop();
                            updateTimers();
                            startButton.classList.add('hidden');
                            stopButton.classList.remove('hidden');
                        } else if (data.status === "finished") {
                            raceStatus = "finished";
                            startButton.classList.add('hidden');
                            stopButton.classList.add('hidden');
                            newRaceButton.classList.remove('hidden');
                        }
                        // if "idle", resetUI() already handled it.
                        break;
                    // END OF NEW BLOCK

                    case 'reset':
                        resetUI();
                        break;

                    case 'light':
                        if (data.light_id > 0 && data.light_id <= 5) {
                            lightsRed[data.light_id - 1].className = data.state === 'on' ? 'light red-on w-12 h-12 md:w-24 md:h-24' : 'light w-12 h-12 md:w-24 md:h-24';
                        }
                        break;

                    case 'lights_out':
                        // MODIFIED: Turn lights 1-4 off
                        for (let i = 0; i < 4; i++) {
                            lightsRed[i].className = 'light w-12 h-12 md:w-24 md:h-24';
                        }
                        // MODIFIED: Turn the 5th light green
                        lightsRed[4].className = 'light green-on w-12 h-12 md:w-24 md:h-24';
                        break;

                    case 'start_race':
                        raceStatus = "running";
                        jsLapStartTime_1 = now;
                        jsLapStartTime_2 = now;

                        // Start the animation loop
                        stopTimerLoop(); // Stop any previous loop
                        updateTimers();

                        // Update button visibility
                        startButton.classList.add('hidden');
                        stopButton.classList.remove('hidden');
                        newRaceButton.classList.add('hidden');
                        break;

                    case 'lap_finish':
                        const formattedTime = formatTime(data.lap_time_sec * 1000);
                        const shortTime = formatTime(data.lap_time_sec * 1000, false);

                        if (data.track === 1) {
                            lastLap1.innerHTML = formattedTime;
                            jsLapStartTime_1 = now; // Reset for next lap
                            // Add to live history
                            const li = document.createElement('li');
                            li.innerText = shortTime;
                            history1.prepend(li);
                            if (history1.children.length > 3) {
                                history1.removeChild(history1.lastChild);
                            }
                        } else if (data.track === 2) {
                            lastLap2.innerHTML = formattedTime;
                            jsLapStartTime_2 = now; // Reset for next lap
                            // Add to live history
                            const li = document.createElement('li');
                            li.innerText = shortTime;
                            history2.prepend(li);
                            if (history2.children.length > 3) {
                                history2.removeChild(history2.lastChild);
                            }
                        }
                        break;

                    case 'race_finished':
                        raceStatus = "finished";
                        stopTimerLoop();
                        jsLapStartTime_1 = 0;
                        jsLapStartTime_2 = 0;

                        // Update button visibility
                        startButton.classList.add('hidden');
                        stopButton.classList.add('hidden');
                        newRaceButton.classList.remove('hidden');

                        // Show summary
                        showRaceSummary(data);
                        break;

                    case 'status':
                        statusText.innerText = data.message;
                        statusLight.className = 'w-3 h-3 rounded-full bg-yellow-500';
                        break;
                }
            };
        }

        function resetUI() {
            console.log("Resetting UI");
            raceStatus = "idle";

            // Reset lights
            lightsRed.forEach(el => el.className = 'light w-12 h-12 md:w-24 md:h-24');
            // REMOVED: lightGreen.className = ...

            // Reset timers
            const defaultTime = '0.000<span class="text-xl">s</span>';
            const clearedTime = '--.---<span class="text-xl">s</span>';
            currentLap1.innerHTML = defaultTime;
            currentLap2.innerHTML = defaultTime;
            lastLap1.innerHTML = clearedTime;
            lastLap2.innerHTML = clearedTime;

            // Clear history
            history1.innerHTML = "";
            history2.innerHTML = "";

            // Reset state
            jsLapStartTime_1 = 0;
            jsLapStartTime_2 = 0;
            stopTimerLoop();

            // Reset buttons
            startButton.disabled = false;
            startButton.classList.remove('hidden');
            stopButton.classList.add('hidden');
            newRaceButton.classList.add('hidden');

            // Hide modal
            summaryModal.classList.add('hidden');
        }

        function showRaceSummary(data) {
            // Clear old summary data
            summaryLaps1.innerHTML = "";
            summaryLaps2.innerHTML = "";

            // Build Track 1 List
            const ol1 = document.createElement('ol');
            ol1.className = "list-decimal list-inside font-mono text-lg space-y-1";
            data.track_1_laps.forEach((lapTime, index) => {
                const li = document.createElement('li');
                let timeStr = lapTime.toFixed(3);
                li.innerText = timeStr;
                if (lapTime === data.track_1_fastest) {
                    li.className = "text-blue-300 font-bold";
                    li.innerText += " (Fastest)";
                }
                ol1.appendChild(li);
            });
            summaryLaps1.appendChild(ol1);

            // Build Track 2 List
            const ol2 = document.createElement('ol');
            ol2.className = "list-decimal list-inside font-mono text-lg space-y-1";
            data.track_2_laps.forEach((lapTime, index) => {
                const li = document.createElement('li');
                let timeStr = lapTime.toFixed(3);
                li.innerText = timeStr;
                if (lapTime === data.track_2_fastest) {
                    li.className = "text-green-300 font-bold";
                    li.innerText += " (Fastest)";
                }
                ol2.appendChild(li);
            });
            summaryLaps2.appendChild(ol2);

            // Show the modal
            summaryModal.classList.remove('hidden');
        }

        // --- Event Listeners ---
        startButton.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('start');
                startButton.disabled = true; // Prevent multiple starts
            }
        };

        stopButton.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('stop');
            }
        };

        newRaceButton.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('reset');
            }
        };

        closeModalButton.onclick = () => {
            summaryModal.classList.add('hidden');
        };

        // --- Initial connect ---
        connectWebSocket();

    </script>
</body>

</html>